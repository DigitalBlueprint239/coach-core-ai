rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Waitlist - allow unauthenticated users to add emails (for signup)
    // But prevent reading the data (security)
    match /waitlist/{emailId} {
      allow create: if true; // Anyone can add to waitlist
      allow read, write, update, delete: if false; // No one can read/modify
    }
    
    // Users can read/write their own profile
    // Allow creation of new user profiles for authentication
    match /users/{userId} {
      allow create: if request.auth != null && request.auth.uid == userId;
      allow read, write, update: if request.auth != null && request.auth.uid == userId;
      // Allow reading other user profiles for team management (display names only)
      allow read: if request.auth != null && 
        (request.auth.uid == userId || 
         (resource.data.teamId != null &&
          exists(/databases/$(database)/documents/teams/$(resource.data.teamId)) &&
          (get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.headCoachId == request.auth.uid ||
           request.auth.uid in get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.assistantCoachIds)));
    }
    
    // Teams - allow creation by authenticated users
    match /teams/{teamId} {
      allow create: if request.auth != null;
      allow read, write: if request.auth != null && 
        (resource.data.headCoachId == request.auth.uid || 
         request.auth.uid in resource.data.assistantCoachIds ||
         // Allow access during team creation
         !exists(resource.data));
    }
    
    // Practice plans - team members can access
    match /practicePlans/{planId} {
      allow create: if request.auth != null;
      allow read, write: if request.auth != null && 
        (resource.data.createdBy == request.auth.uid ||
         (exists(/databases/$(database)/documents/teams/$(resource.data.teamId)) &&
          (get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.headCoachId == request.auth.uid ||
           request.auth.uid in get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.assistantCoachIds)));
    }
    
    // Plays - team members can access
    match /plays/{playId} {
      allow create: if request.auth != null;
      allow read, write: if request.auth != null && 
        (resource.data.createdBy == request.auth.uid ||
         (exists(/databases/$(database)/documents/teams/$(resource.data.teamId)) &&
          (get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.headCoachId == request.auth.uid ||
           request.auth.uid in get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.assistantCoachIds)));
    }
    
    // Player data - team members can access
    match /players/{playerId} {
      allow create: if request.auth != null;
      allow read, write: if request.auth != null && 
        (resource.data.createdBy == request.auth.uid ||
         (exists(/databases/$(database)/documents/teams/$(resource.data.teamId)) &&
          (get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.headCoachId == request.auth.uid ||
           request.auth.uid in get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.assistantCoachIds)));
    }
    
    // Attendance records - team members can access
    match /attendance/{recordId} {
      allow create: if request.auth != null;
      allow read, write: if request.auth != null && 
        (resource.data.createdBy == request.auth.uid ||
         (exists(/databases/$(database)/documents/teams/$(resource.data.teamId)) &&
          (get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.headCoachId == request.auth.uid ||
           request.auth.uid in get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.assistantCoachIds)));
    }
    
    // AI insights - team members can access
    match /aiInsights/{insightId} {
      allow create: if request.auth != null;
      allow read, write: if request.auth != null && 
        (resource.data.createdBy == request.auth.uid ||
         (exists(/databases/$(database)/documents/teams/$(resource.data.teamId)) &&
          (get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.headCoachId == request.auth.uid ||
           request.auth.uid in get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.assistantCoachIds)));
    }
    
    // Games - team members can access
    match /games/{gameId} {
      allow create: if request.auth != null;
      allow read, write: if request.auth != null && 
        (resource.data.createdBy == request.auth.uid ||
         (exists(/databases/$(database)/documents/teams/$(resource.data.teamId)) &&
          (get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.headCoachId == request.auth.uid ||
           request.auth.uid in get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.assistantCoachIds)));
    }
    
    // Assessments - team members can access
    match /assessments/{assessmentId} {
      allow create: if request.auth != null;
      allow read, write: if request.auth != null && 
        (resource.data.createdBy == request.auth.uid ||
         (exists(/databases/$(database)/documents/teams/$(resource.data.teamId)) &&
          (get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.headCoachId == request.auth.uid ||
           request.auth.uid in get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.assistantCoachIds)));
    }
    
    // Default deny all
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
