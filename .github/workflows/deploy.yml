name: ðŸš€ Deploy to Firebase Hosting

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Node.js v18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ðŸ“¦ Cache node_modules
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
          
    - name: ðŸ“¦ Install dependencies
      run: npm ci
      
    - name: ðŸ” Verify package.json and firebase.json
      run: |
        if [ ! -f "package.json" ]; then
          echo "âŒ package.json not found!"
          exit 1
        fi
        if [ ! -f "firebase.json" ]; then
          echo "âŒ firebase.json not found!"
          exit 1
        fi
        if [ ! -f "deploy.sh" ]; then
          echo "âŒ deploy.sh not found!"
          exit 1
        fi
        echo "âœ… All required files found"
        
    - name: ðŸ”¨ Build application
      run: npm run build
      
    - name: ðŸ“ Verify build output
      run: |
        if [ ! -d "dist" ]; then
          echo "âŒ Build failed - dist directory not created!"
          exit 1
        fi
        if [ ! -f "dist/index.html" ]; then
          echo "âŒ Build failed - index.html not found in dist!"
          exit 1
        fi
        echo "âœ… Build output verified"
        echo "ðŸ“Š Build contents:"
        ls -la dist/
        
    - name: ðŸ”§ Setup Firebase CLI
      run: npm install -g firebase-tools
      
    - name: ðŸ” Authenticate with Firebase
      run: |
        echo "${{ secrets.FIREBASE_TOKEN }}" | firebase login --token
        firebase use --add coach-core-ai --token ${{ secrets.FIREBASE_TOKEN }}
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        
    - name: ðŸš€ Run deployment verification
      run: ./deploy.sh --fast
      
    - name: ðŸŒ Deploy to Firebase Hosting
      run: |
        firebase deploy --only hosting --token ${{ secrets.FIREBASE_TOKEN }}
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        
    - name: âœ… Deployment success
      run: |
        echo "ðŸŽ‰ Deployment completed successfully!"
        echo "ðŸŒ Your app is live at: https://coach-core-ai.web.app"
        
    - name: ðŸ“Š Build summary
      if: always()
      run: |
        echo "## ðŸ“Š Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Node.js Version**: $(node --version)" >> $GITHUB_STEP_SUMMARY
        echo "- **NPM Version**: $(npm --version)" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment URL**: https://coach-core-ai.web.app" >> $GITHUB_STEP_SUMMARY
        if [ -d "dist" ]; then
          echo "- **Build Size**: $(du -sh dist | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "- **Files Count**: $(find dist -type f | wc -l)" >> $GITHUB_STEP_SUMMARY
        fi

